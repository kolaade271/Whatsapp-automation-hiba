# WafR WhatsApp Chatbot - Conversation Flow Diagram

## Complete Flow Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER SENDS ANY GREETING                       â”‚
â”‚                     (Hi, Hello, Ù…Ø±Ø­Ø¨Ø§, etc.)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WELCOME MESSAGE (Bilingual)                   â”‚
â”‚  Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ ÙØ¶Ø§Ø¡ WafR                                         â”‚
â”‚  Bienvenue dans l'espace de WafR                                â”‚
â”‚                                                                  â”‚
â”‚  Entrez 1ï¸âƒ£ pour le FranÃ§ais                                     â”‚
â”‚  Ø£Ø¯Ø®Ù„ÙˆØ§ 2ï¸âƒ£ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
        â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   1    â”‚        â”‚   2    â”‚
   â”‚ French â”‚        â”‚ Arabic â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜        â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚
        â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SERVICE MENU â”‚  â”‚ SERVICE MENU â”‚
â”‚   (French)   â”‚  â”‚   (Arabic)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. IAM       â”‚  â”‚ 10. IAM      â”‚
â”‚ 2. INWI      â”‚  â”‚ 11. INWI     â”‚
â”‚ 3. ORANGE    â”‚  â”‚ 12. ORANGE   â”‚
â”‚ 4-9. Coming  â”‚  â”‚ 13-18. Ù‚Ø±ÙŠØ¨Ø§ â”‚
â”‚      Soon    â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â”‚ (1,2,3)      â”‚ (10,11,12)
       â”‚              â”‚
       â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PHONE NUMBER INPUT            â”‚
â”‚  ğŸ“± Veuillez entrer le numÃ©ro   â”‚
â”‚  ğŸ“± Ø§Ù„Ù…Ø±Ø¬Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AMOUNT SELECTION             â”‚
â”‚  ğŸ’° Select amount (1-9):        â”‚
â”‚  1. 5 DH    6. 50 DH            â”‚
â”‚  2. 10 DH   7. 100 DH           â”‚
â”‚  3. 20 DH   8. 200 DH           â”‚
â”‚  4. 25 DH   9. 300 DH           â”‚
â”‚  5. 30 DH                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OFFER SELECTION              â”‚
â”‚  ğŸ Select offer (1-12):        â”‚
â”‚  1. Recharge Multiple           â”‚
â”‚  2. Pass SMS                    â”‚
â”‚  3. Pass Jawal                  â”‚
â”‚  4. Pass National               â”‚
â”‚  5. Pass Internet               â”‚
â”‚  6. Pass International          â”‚
â”‚  7. Pass Tout En Un             â”‚
â”‚  8. Pass RÃ©seaux Sociaux        â”‚
â”‚  9. Pass Tiktok et Youtube      â”‚
â”‚  10. Pass Roaming               â”‚
â”‚  11. Roaming Data               â”‚
â”‚  12. Service Premium            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CONFIRMATION SUMMARY          â”‚
â”‚  ğŸ“‹ RÃ©capitulatif:              â”‚
â”‚  ğŸ¢ OpÃ©rateur: IAM              â”‚
â”‚  ğŸ“± Destinataire: 06 XX XX XX   â”‚
â”‚  ğŸ’° Montant: 50 DH              â”‚
â”‚  ğŸ Offre: Pass Internet        â”‚
â”‚                                  â”‚
â”‚  Confirmer / Annuler            â”‚
â”‚  ØªØ£ÙƒÙŠØ¯ / Ø¥Ù„ØºØ§Ø¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONFIRM â”‚ â”‚ CANCEL  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚           â”‚
     â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS â”‚ â”‚ CANCEL  â”‚
â”‚ MESSAGE â”‚ â”‚ MESSAGE â”‚
â”‚    âœ…   â”‚ â”‚    âŒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Session State Tracking

```
UserSession {
    phone_number: "212612345678"
    language: "fr" | "ar" | null
    current_step: "welcome" | "language_selection" | "service_menu" | 
                  "phone_number" | "amount_selection" | "offer_selection" | 
                  "confirmation"
    data: {
        operator: "IAM" | "INWI" | "ORANGE"
        phone: "06 XX XX XX XX"
        amount: "5" | "10" | "20" | "25" | "30" | "50" | "100" | "200" | "300"
        offer: "Recharge Multiple" | "Pass SMS" | ...
    }
    created_at: timestamp
    last_activity: timestamp
}
```

## API Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WhatsApp â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Webhook â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Flow    â”‚
â”‚   User   â”‚         â”‚ Handler  â”‚         â”‚ Handler  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                                          â”‚
     â”‚                                          â–¼
     â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ WhatsApp â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Session  â”‚
                     â”‚  Client  â”‚         â”‚ Manager  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Responsibilities

```
main.py
  â””â”€â–¶ Initialize FastAPI app
  â””â”€â–¶ Include webhook router
  â””â”€â–¶ Health check endpoints

bot/webhook.py
  â””â”€â–¶ Verify webhook (GET)
  â””â”€â–¶ Receive messages (POST)
  â””â”€â–¶ Extract message data
  â””â”€â–¶ Call flow handler

bot/flow_handler.py
  â””â”€â–¶ Process user message
  â””â”€â–¶ Determine current step
  â””â”€â–¶ Route to appropriate handler
  â””â”€â–¶ Return bot response

bot/session_manager.py
  â””â”€â–¶ Create/get user sessions
  â””â”€â–¶ Track conversation state
  â””â”€â–¶ Clean expired sessions
  â””â”€â–¶ Reset sessions

bot/messages.py
  â””â”€â–¶ Welcome message
  â””â”€â–¶ Service menus (FR/AR)
  â””â”€â–¶ Prompts (FR/AR)
  â””â”€â–¶ Confirmation messages
  â””â”€â–¶ Success/error messages

bot/whatsapp_client.py
  â””â”€â–¶ Send text messages
  â””â”€â–¶ Send interactive buttons
  â””â”€â–¶ Mark messages as read
  â””â”€â–¶ Handle API errors
```

## Error Handling Flow

```
User Message
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validation  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚ Valid â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Process   â”‚â”€â”€â”€â”€â–¶â”‚  Error?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                    â”‚         â”‚
                    â–¼         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Success â”‚ â”‚  Error  â”‚
              â”‚ Responseâ”‚ â”‚ Message â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Coming Soon Services

```
French (4-9):
  4. Consulter mon solde WafR
  5. Alimenter mon solde WafR
  6. Retirer de mon solde WafR
  7. Payer une Facture
  8. Envoyer le Cash via CODE
  9. Retirer le Cash via CODE

Arabic (13-18):
  13. Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯ÙŠ ÙÙŠ ÙˆÙØ±
  14. ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯ÙŠ
  15. Ø³Ø­Ø¨ Ù…Ù† Ø±ØµÙŠØ¯ÙŠ
  16. Ø£Ø¯Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©
  17. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù‚ÙˆØ¯ Ø¹Ø¨Ø± ÙƒÙˆØ¯
  18. Ø³Ø­Ø¨ Ø§Ù„Ù†Ù‚ÙˆØ¯ Ø¹Ø¨Ø± ÙƒÙˆØ¯

Response: "â³ Ce service va Ãªtre disponible prochainement"
          "â³ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ø³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ø§"
```
